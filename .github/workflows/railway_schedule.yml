name: Railway Auto Shutdown/Startup

on:
  schedule:
    # Apagar a las 11 PM Venezuela (UTC-4 = 3 AM UTC)
    - cron: '0 3 * * *'
    # Encender a las 7 AM Venezuela (UTC-4 = 11 AM UTC)
    - cron: '0 11 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - stop

jobs:
  manage-services:
    runs-on: ubuntu-latest
    steps:
      - name: Determine action
        id: action
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" -eq 3 ]; then
              echo "action=stop" >> $GITHUB_OUTPUT
            else
              echo "action=start" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Stop services
        if: steps.action.outputs.action == 'stop'
        run: |
          echo "üåô Apagando servicios (11 PM)..."
          curl -X POST https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { serviceInstanceUpdate(input: {serviceId: \"${{ secrets.RAILWAY_SERVICE_WEB }}\", numReplicas: 0}) { id } }"}'
          curl -X POST https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { serviceInstanceUpdate(input: {serviceId: \"${{ secrets.RAILWAY_SERVICE_WORKER }}\", numReplicas: 0}) { id } }"}'
          curl -X POST https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { serviceInstanceUpdate(input: {serviceId: \"${{ secrets.RAILWAY_SERVICE_BEAT }}\", numReplicas: 0}) { id } }"}'
          echo "‚úÖ Servicios apagados"
      
      - name: Start services
        if: steps.action.outputs.action == 'start'
        run: |
          echo "‚òÄÔ∏è Encendiendo servicios (7 AM)..."
          curl -X POST https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { serviceInstanceUpdate(input: {serviceId: \"${{ secrets.RAILWAY_SERVICE_WEB }}\", numReplicas: 1}) { id } }"}'
          curl -X POST https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { serviceInstanceUpdate(input: {serviceId: \"${{ secrets.RAILWAY_SERVICE_WORKER }}\", numReplicas: 1}) { id } }"}'
          curl -X POST https://backboard.railway.com/graphql/v2 \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"query":"mutation { serviceInstanceUpdate(input: {serviceId: \"${{ secrets.RAILWAY_SERVICE_BEAT }}\", numReplicas: 1}) { id } }"}'
          echo "‚úÖ Servicios encendidos"
